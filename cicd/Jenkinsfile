def REPOS = [
  'user-service': 'https://github.com/DRSOL-HA/WebBoard-Service.git',
  'file-service': 'https://github.com/DRSOL-HA/WebBoard-Service.git',
  'post-service': 'https://github.com/DRSOL-HA/WebBoard-Service.git',
  'frontend'    : 'https://github.com/DRSOL-HA/WebBoard-Service.git',
  'nginx'       : 'https://github.com/DRSOL-HA/WebBoard-Service.git',
]

pipeline {
  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: "buildkit"
spec:
  serviceAccountName: jenkins
  restartPolicy: Never
  volumes:
    - name: tls
      secret:
        secretName: buildkit-client-tls
    - name: workspace-volume
      emptyDir: {}
  containers:
    - name: buildctl
      image: moby/buildkit:rootless
      command: ["cat"]
      tty: true
      volumeMounts:
        - { name: tls, mountPath: /tls, readOnly: true }
        - { name: workspace-volume, mountPath: /home/jenkins/agent }
    - name: git
      image: alpine/git:2.45.2
      securityContext: { runAsUser: 0, runAsGroup: 0 }
      command: ["cat"]
      tty: true
      volumeMounts:
        - { name: workspace-volume, mountPath: /home/jenkins/agent }
    - name: yq
      image: ghcr.io/mikefarah/yq:4
      securityContext: { runAsUser: 0, runAsGroup: 0 }
      command: ["cat"]
      tty: true
      volumeMounts:
        - { name: workspace-volume, mountPath: /home/jenkins/agent }
    - name: utils
      image: alpine:3.20
      securityContext: { runAsUser: 0, runAsGroup: 0 }
      command: ["cat"]
      tty: true
      volumeMounts:
        - { name: workspace-volume, mountPath: /home/jenkins/agent }
"""
    }
  }

  parameters {
    choice(
      name: 'SERVICE',
      choices: 'user-service\nfile-service\npost-service\nfrontend\nnginx',
      description: '빌드할 서비스(디렉터리) 선택'
    )
    string(name: 'IMAGE_TAG', defaultValue: '', description: '지정하면 해당 태그로 푸시, 비우면 vN 자동 증가')
    string(name: 'GIT_CRED_ID',   defaultValue: 'GITHUB_PAT',  description: 'GitHub(소스/manifest) PAT 크리덴셜 ID')
    string(name: 'GHCR_CRED_ID',  defaultValue: 'ghcr-owner',  description: 'GHCR(이미지 푸시) PAT 크리덴셜 ID')
  }

  options {
    disableResume()
    durabilityHint('PERFORMANCE_OPTIMIZED')
    skipDefaultCheckout(true)
  }

  environment {
    REGISTRY = 'ghcr.io'
    ORG      = 'drsol-ha'  // GHCR 조직/오너 (소문자 권장)
  }

  stages {

    stage('Checkout Jenkinsfile repo (self)') {
      steps { checkout scm }
    }

    stage('Init env (mapping)') {
      steps {
        script {
          def imageMap = [
            'user-service': 'board-user-service',
            'file-service': 'board-file-service',
            'post-service': 'board-post-service',
            'frontend'    : 'board-frontend',
            'nginx'       : 'board-nginx',
          ]
          if (!imageMap.containsKey(params.SERVICE)) {
            error "Unknown SERVICE: ${params.SERVICE}"
          }
          env.IMAGE_REPO = imageMap[params.SERVICE]

          env.SRC_REPO = REPOS[params.SERVICE]
        }
      }
    }

    stage('Checkout service code') {
      steps {
        container('git') {
          withCredentials([usernamePassword(credentialsId: params.GIT_CRED_ID, usernameVariable: 'GH_USER', passwordVariable: 'GH_PAT')]) {
            sh '''
              set -eu
              rm -rf src && mkdir -p src
              AUTH=$(printf '%s:%s' "$GH_USER" "$GH_PAT" | base64 | tr -d '\\n')
              git -c "http.extraheader=AUTHORIZATION: Basic ${AUTH}" \
                  clone --depth=1 -b main "${SRC_REPO}" src/app
            '''
          }
        }
      }
    }

    stage('Resolve build context') {
      steps {
        container('yq') { // yq 컨테이너지만 쉘만 사용
          sh '''
            set -eu
            HINT="$(printf '%s' "${SERVICE}" | sed 's/-service$//')"
            FOUND=""
            for p in \
              "src/app/services/${SERVICE}" \
              "src/app/services/${HINT}" \
              "src/app/apps/${SERVICE}" \
              "src/app/apps/${HINT}" \
              "src/app/packages/${SERVICE}" \
              "src/app/packages/${HINT}" \
              "src/app/${SERVICE}" \
              "src/app/${HINT}"; do
              if [ -f "${p}/Dockerfile" ]; then FOUND="$(basename "$p")"; echo "$FOUND" > .build_context_path; break; fi
            done
            test -s .build_context_path && echo "Detected build context: $(cat .build_context_path)" || {
              echo "ERROR: Dockerfile을 찾을 수 없습니다 (SERVICE=${SERVICE})." >&2
              exit 2
            }
          '''
        }
      }
    }

    stage('Sanity: GHCR push permission') {
      steps {
        container('utils') {
          withCredentials([usernamePassword(credentialsId: params.GHCR_CRED_ID, usernameVariable: 'GHCR_USR', passwordVariable: 'GHCR_PSW')]) {
            sh '''
              set -eu
              apk add --no-cache curl jq ca-certificates >/dev/null
              REPO="${IMAGE_REPO}"
              TOKEN="$(curl -sS -u "${GHCR_USR}:${GHCR_PSW}" \
                "https://ghcr.io/token?service=ghcr.io&scope=repository:${ORG}/${REPO}:pull,push" | jq -r .token)"

              if [ -z "${TOKEN}" ] || [ "${TOKEN}" = "null" ]; then
                echo "ERROR: GHCR 토큰 발급 실패 (크리덴셜/SSO/권한 확인)." >&2
                exit 90
              fi

              CODE="$(curl -sS -o /dev/null -w '%{http_code}' \
                -H "Authorization: Bearer ${TOKEN}" \
                -X POST "https://ghcr.io/v2/${ORG}/${REPO}/blobs/uploads/")"

              case "${CODE}" in
                201|202) echo "GHCR push check OK (${CODE})" ;;
                401|403) echo "ERROR: GHCR 권한 거부(${CODE}). PAT write:packages + Org 정책/SSO 확인 필요." >&2; exit 91 ;;
                404)     echo "ERROR: Package(${ORG}/${REPO}) 미존재. 최초 생성 권한/정책 확인." >&2; exit 92 ;;
                *)       echo "ERROR: GHCR 업로드 세션 실패 (HTTP ${CODE})." >&2; exit 93 ;;
              esac

              touch .push_ok
            '''
          }
        }
      }
    }

    stage('Decide IMAGE_TAG (auto bump when empty)') {
      when { expression { return (params.IMAGE_TAG?.trim() == '') } }
      steps {
        container('utils') {
          withCredentials([usernamePassword(credentialsId: params.GHCR_CRED_ID, usernameVariable: 'GHCR_USR', passwordVariable: 'GHCR_PSW')]) {
            sh '''
              set -eu
              apk add --no-cache curl jq ca-certificates >/dev/null
              TOKEN="$(curl -sS -u "${GHCR_USR}:${GHCR_PSW}" \
                "https://ghcr.io/token?service=ghcr.io&scope=repository:${ORG}/${IMAGE_REPO}:pull" | jq -r .token)"

              curl -sS -H "Authorization: Bearer ${TOKEN}" \
                "https://ghcr.io/v2/${ORG}/${IMAGE_REPO}/tags/list?n=1000" > tags.json || echo '{"tags":[]}' > tags.json

              NEXT_TAG="$(jq -r '
                  (.tags // []) | map(select(test("^v[0-9]+$"))) |
                  (map(sub("^v";"")|tonumber) | max // 0) + 1 | "v"+tostring
                ' tags.json)"
              echo "${NEXT_TAG}" > .image_tag
              echo "Auto-decided IMAGE_TAG: ${NEXT_TAG}"
            '''
          }
        }
      }
    }

    stage('Use provided IMAGE_TAG (if any)') {
      when { expression { return (params.IMAGE_TAG?.trim() != '') } }
      steps {
        sh '''
          set -eu
          printf '%s' "${IMAGE_TAG}" > .image_tag
          echo "Using IMAGE_TAG=$(cat .image_tag)"
        '''
      }
    }

    stage('Build & Push image') {
      steps {
        container('buildctl') {
          withCredentials([usernamePassword(credentialsId: params.GHCR_CRED_ID, usernameVariable: 'GHCR_USR', passwordVariable: 'GHCR_PSW')]) {
            sh '''
              set -eu
              CONTEXT_PATH="$(cat .build_context_path)"
              IMAGE_TAG="$(cat .image_tag)"
              IMAGE_NAME="${REGISTRY}/${ORG}/${IMAGE_REPO}"

              export HOME="$PWD"
              export DOCKER_CONFIG="$PWD/.docker"
              mkdir -p "$DOCKER_CONFIG"

              AUTH="$(printf '%s:%s' "${GHCR_USR}" "${GHCR_PSW}" | base64 | tr -d '\\n')"
              printf '{ "auths": { "%s": { "auth": "%s" } } }\n' "${REGISTRY}" "${AUTH}" > "$DOCKER_CONFIG/config.json"

              echo "[buildctl] building ${IMAGE_NAME}:${IMAGE_TAG} from ${CONTEXT_PATH}"
              buildctl --addr tcp://buildkitd.buildkit.svc.cluster.local:1234 \
                --tlscacert /tls/ca.crt --tlscert /tls/client.crt --tlskey /tls/client.key \
                build \
                  --frontend=dockerfile.v0 \
                  --local "context=src/app/${CONTEXT_PATH}" \
                  --local "dockerfile=src/app/${CONTEXT_PATH}" \
                  --output "type=image,name=${IMAGE_NAME}:${IMAGE_TAG},push=true" \
                  --progress=plain \
                  --metadata-file "$PWD/.buildmeta.json"
            '''
          }
        }
      }
    }

    stage('Bump manifest tag') {
      when { expression { return fileExists('.image_tag') && fileExists('.push_ok') } }
      steps {
        withCredentials([usernamePassword(credentialsId: params.GIT_CRED_ID, usernameVariable: 'GH_USER', passwordVariable: 'GH_PAT')]) {

          // 1) clone
          container('git') {
            sh '''
              set -eu
              rm -rf manifest && mkdir -p manifest && cd manifest
              AUTH="$(printf '%s:%s' "$GH_USER" "$GH_PAT" | base64 | tr -d '\\n')"
              git -c "http.extraheader=AUTHORIZATION: Basic ${AUTH}" \
                  clone --depth=1 https://github.com/DRSOL-HA/deploy_manifest.git repo
            '''
          }

          // 2) edit with yq
          container('yq') {
            sh '''
              set -eu
              cd manifest/repo

              IMAGE_LOWER="ghcr.io/${ORG}/${IMAGE_REPO}"
              IMAGE_UPPER="ghcr.io/${ORG^^}/${IMAGE_REPO}"   # bash zsh 호환 위해 ^^ 대신 env 대체 불가 시 Groovy서치 사용 가능

              FILE="apps/board/kustomization.yaml"
              test -f "${FILE}"

              export NEW_TAG="$(cat "$WORKSPACE/.image_tag")"
              export IMG_LOWER="${IMAGE_LOWER}"
              export IMG_UPPER="${IMAGE_UPPER}"

              yq -i '
                (.images[] | select((.name == strenv(IMG_LOWER)) or (.name == strenv(IMG_UPPER))).newTag)
                = strenv(NEW_TAG)
              ' "${FILE}"
            '''
          }

          // 3) commit & push
          container('git') {
            sh '''
              set -eu
              cd manifest/repo
              git config user.name  "jenkins"
              git config user.email "ci@drsol-ha.local"
              git add -A
              git commit -m "ci: bump ${IMAGE_REPO} -> $(cat "$WORKSPACE/.image_tag")" || true

              AUTH_PUSH="$(printf '%s:%s' "$GH_USER" "$GH_PAT" | base64 | tr -d '\\n')"
              git -c "http.extraheader=AUTHORIZATION: Basic ${AUTH_PUSH}" push origin HEAD:main
            '''
          }
        }
      }
    }
  }

  post {
    always {
      script {
        echo "SERVICE=${params.SERVICE}"
        sh '''
          set -eu
          ls -lA || true
          if [ -f .image_tag ]; then echo "IMAGE_TAG=$(cat .image_tag)"; fi
          if [ -f .push_ok ]; then echo ".push_ok present"; else echo ".push_ok missing"; fi
        '''
      }
    }
  }
}
